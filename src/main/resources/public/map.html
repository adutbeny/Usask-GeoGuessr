<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Campus Map</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #005100;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        let marker;
        let map;
        let resultLine;
        let correctMarker;
        let distanceInfoWindow;
        function initMap() {
            const campusBounds = {
                north: 52.139,
                south: 52.125,
                west: -106.6547,
                east: -106.6215
            };

            // creates the map
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 52.13, lng: -106.63 },
                zoom: 15,
                mapTypeId: "satellite",

                // this makes so zooming in doesnt turn the view sideways
                tilt: 0,
                heading: 0,

                restriction: {
                    latLngBounds: campusBounds,
                    strictBounds: true
                },
                // making the map a little cleaner by removing default things
                streetViewControl: false,
                mapTypeControl: false,
                rotateControl: false,
                fullscreenControl: false,
                zoomControl: false,

            });
            // this prints to console the coords of where a mouse was clicked on the map
            // we need to use this information to calculate the distances from real point to point clicked
            map.addListener("click", (event) => {
                const lat = event.latLng.lat();
                const lng = event.latLng.lng();
                alert(`Coordinates: ${lat}, ${lng}`);

                if (!marker) { // creates new marker if we havnt already made one
                    marker = new google.maps.Marker({
                        position: event.latLng,
                        map: map,
                    });
                } else {    // if marker already exists then move the existing one to new clicked position
                    marker.setPosition(event.latLng)
                }
                if (window.javaApp && typeof window.javaApp.updateMarkerCoordinates == "function") {
                    alert("Calling updateMarkerCoordinates..."); // debugging
                    window.javaApp.updateMarkerCoordinates(lat, lng);
                } else {
                    alert("Calling updateMarkerCoordinates... FAILED"); //debugging
                }
            });
        }
        function showResult(guessedLat, guessedLng, correctLat, correctLng, precomputedDistance) {
            alert(`showResult called with: ${guessedLat} ${guessedLng} ${correctLat} ${correctLng} ${precomputedDistance}`)
            const guessedLocation = new google.maps.LatLng(guessedLat, guessedLng);
            const correctLocation = new google.maps.LatLng(correctLat, correctLng);

            // creates the dash symbol
            const dashSymbol = {
                path: 'M 0,0 L15,0',
                strokeOpacity: 1,
                strokeColor: '#149563',
                strokeWeight: 8,
                scale: 1
            };

            // will remove existing line
            if (resultLine) {
                resultLine.setMap(null);
            }

            // draws out the actual line
            resultLine = new google.maps.Polyline({
                path: [guessedLocation, correctLocation],
                strokeOpacity: 0,
                icons: [{
                    icon: dashSymbol,
                    offset: '0',
                    repeat: '25px'
                }],
                map: map
            });

            // removes any markers that may exist
            if (correctMarker) {
                correctMarker.setMap(null);
            }

            // draws correct marker
            correctMarker = new google.maps.Marker({
                position: correctLocation,
                map: map,
                title: "Correct Location",
                icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            });
            const midLat = (guessedLat + correctLat) / 2;
            const midLng = (guessedLng + correctLng) / 2;
            const contentString = `<div style="color: #0A6A42; font-weight: bold;">${precomputedDistance.toFixed(0)} m away</div>`;

            // removes any existing InfoWindow
            if (distanceInfoWindow) {
                distanceInfoWindow.close();
            }
            distanceInfoWindow = new google.maps.InfoWindow({
                content: contentString,
                position: {lat: midLat, lng: midLng}
            });
            distanceInfoWindow.open(map);
        }
        function clearMapOverlays() {
            if (resultLine) { resultLine.setMap(null); resultLine = null; }
            if (correctMarker) { correctMarker.setMap(null); correctMarker = null; }
            if (distanceInfoWindow) { distanceInfoWindow.close(); distanceInfoWindow = null; }
        }
    </script>
    <script
            defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKAGrVlkSOCmxmG8yPlGZ1A_j4GkKvzGE&callback=initMap">
    </script>
</head>
<body>
<div id="map"></div>
</body>
</html>